# 出馬表アプリ データ仕様（UI向けJSON）

本仕様は、フロントエンドが `public/data/date1.json`〜`date4.json` から読み込む RaceDay JSON の構造を定義する。各ファイルは1日分（1 RaceDay）を表す。

## ファイル配置
- 公開用最新4件: `public/data/date1.json`（最古）〜`date4.json`（最新）
- 生成元の参考:
  - PostgreSQL 版: `scripts/pg/export-raceday.ts`（`--publish-latest` で最新4件を反映）
  - SQLite 版: `scripts/sqlite/export_raceday.py`
  - スクレイピング経由の中間からの変換: `scripts/netkeiba/convert-to-raceday.ts`

## 文字コード/形式
- UTF-8 / JSON（単一オブジェクト）。

## ルートオブジェクト: RaceDay
- 型（概念）
  - `RaceDay = { date: string; meetings: Meeting[] }`
- フィールド
  - `date: string` 例: `"2024-09-14"`（ISO形式）
  - `meetings: Meeting[]` 開催の配列。

## Meeting（開催）
- 型（概念）
  - `Meeting = { track: string; kaiji: number; nichiji: number; races: Race[] }`
- フィールド
  - `track: string` 例: `"東京"`, `"阪神"`
  - `kaiji: number` 何回開催
  - `nichiji: number` 何日目
  - `races: Race[]` 当日のレース一覧

## Race（レース）
- 型（概念）
  - `Race = { no: number; name: string; distance_m: number; ground: string; course_note?: string; condition?: string; start_time?: string; pace_score?: number; pace_mark?: string; horses: Horse[] }`
- フィールド
  - `no: number` レース番号（1..12 等）
  - `name: string` レース名
  - `distance_m: number` 距離（メートル）
  - `ground: string` 馬場種別（例: `芝`, `ダート`）
  - `course_note?: string` コース補足（例: `右外`, `内` など）
  - `condition?: string` 馬場状態（例: `良`, `稍重`）
  - `start_time?: string` 発走時刻（例: `15:45`）
  - `pace_score?: number` 展開カウント（例: 3, -1 など）
  - `pace_mark?: string` 展開ランク記号（例: `A`, `B`, `C` など、または空）
  - `horses: Horse[]` 出走馬一覧

## Horse（馬）
- 型（概念）
  - `Horse = { num: number; draw: number; name: string; sex: string; age: number; weight: number; jockey: string; trainer: string; odds?: number; popularity?: number; pace_type?: Array<'A'|'B'|'C'> }`
- フィールド
  - `num: number` 馬番
  - `draw: number` 枠番（1..8）
  - `name: string` 馬名
  - `sex: string` 性別（`牡`, `牝`, `セ` 等）
  - `age: number` 年齢（整数）
  - `weight: number` 斤量（kg、小数1桁程度）
  - `jockey: string` 騎手名（略称を含む場合あり）
  - `trainer: string` 調教師名（略称を含む場合あり）
  - `odds?: number` 単勝オッズ（小数1桁程度）
  - `popularity?: number` 人気（整数、1=1番人気）
  - `pace_type?: string[]` 展開型の配列。例: `['A']`, `['A','B']`, `['C']`

## バリデーション/前提
- `date` は `YYYY-MM-DD`。
- `meetings` は1日内の開催を配列で持つ。`track` はユニーク。
- `races` は `no` でユニーク。UI側では 1..maxR でグリッド化し、存在しない番号は薄表示。
- 数値項目は数値として格納（UI側で `toFixed(1)` 等の表示整形を行う）。
- 欠損データ（未確定等）は省略または `undefined`。UIは `-` 等のフォールバック表示。

## UIでの利用方法（要点）
- トップ: `RaceDay[]` をロードし、日付リンク＋開催バッジを表示。
- 日付別一覧: `RaceDay` の `meetings[*].races` をグリッド表示。
- 出馬表: `Race` を抽出し `horses` を `num`/`odds`/`popularity` でソート切替。
- 見出し: `pace_score`/`pace_mark`、`distance_m`、`ground`、`course_note`、`condition`、`start_time` を `formatRaceHeader` で連結。

## 生成ロジック備考
- PostgreSQL 由来（`scripts/pg/export-raceday.ts`）:
  - 主要テーブル: `jvd_ra`（レース）, `jvd_se`（出走）, `jvd_um`（馬マスタ）
  - 日付抽出 → レースと出走の結合 → RaceDay へ整形
  - `weight`: DB格納の数値を小数1桁へ丸め
  - `pace_type`/`pace_score`/`pace_mark`: 過去ラップ等から算出（ロジック詳細はコード参照）
- SQLite 由来（`scripts/sqlite/export_raceday.py`）も同等の型を出力。

## サンプル（抜粋）
```json
{
  "date": "2024-09-14",
  "meetings": [
    {
      "track": "東京",
      "kaiji": 4,
      "nichiji": 5,
      "races": [
        {
          "no": 11,
          "name": "オータムハンデ",
          "distance_m": 1600,
          "ground": "芝",
          "course_note": "左外",
          "condition": "良",
          "start_time": "15:45",
          "pace_score": 3,
          "pace_mark": "A",
          "horses": [
            {
              "num": 1,
              "draw": 1,
              "name": "サンプルホース",
              "sex": "牡",
              "age": 5,
              "weight": 57.0,
              "jockey": "騎手A",
              "trainer": "調教師A",
              "odds": 4.2,
              "popularity": 2,
              "pace_type": ["A"]
            }
          ]
        }
      ]
    }
  ]
}
```

## 互換性/拡張
- 新規フィールドは基本的にオプショナルで追加し、既存UIを壊さない方針。
- `pace_*` 系の算出ロジックの見直しは値の分布に影響するため、UI表示・説明文書の更新も併せて行う。
