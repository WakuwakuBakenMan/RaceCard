# 開発メモ（2025-09-27 時点）

## 決定事項
- 三連単は採用しない（展開タイプA≥2の「A-A-BC」は良かったが対象が少ないため不採用）。
- 券種は「馬連」のみで検討。ワイドは現状不採用。

## バックテスト実装（展開タイプ基準）
- スクリプト
  - `scripts/analytics/backtest-pairs.ts`
    - 展開タイプ A/B/C を「過去3走」から付与して集計
    - 組み合わせ: AA, AB, BB（cap=10固定、今後cap無限＝全組も可）
    - Cのみレースは除外
    - 出力: `data/analytics/pairs-backtest-YYYY-MM-DD.json`
  - `scripts/analytics/print-pairs-table.ts`
    - Markdown表: `data/analytics/pairs-backtest-latest.md`

- 直近結果（アンカー 2025-09-27, 対象3年）
  - 馬連AA: ROI≈1.846, races≈277
  - 馬連AB: ROI≈1.348（例: A1×B2軸）, races≈1,422
  - 馬連BB/BC: ROI<1（最高でも0.75前後）→不採用

## 出力コマンド（再起動後推奨）
- 再集計: `npm run -s bt:pairs -- 20250927 3`
- 表表示（EPIPE回避）: `sed -n '1,80p' data/analytics/pairs-backtest-latest.md | cat`

## 既知の注意
- `backtest-pairs.ts` は try/catch/finally と多重forの括弧不整合を修正済み。
- EPIPE回避のため `head` より `sed/cat` を推奨。
- 当日（速報）データは基本 SQLite/スクレイピング経路、PG は確定(6/7)のみ（data_kubun=2 は除外）。

## 次にやること（この順で）
1. 層別集計の追加（馬連のみ）
   - 軸: 競馬場（JYOコード）、馬場（芝/ダ）、展開バイアス有/無（pace_score<=4.0 かつ != -3.5）
   - 組み合わせ: AA, AB, BB
   - capは無限（全組）
   - 出力: `rows` に `jyo`, `ground`, `bias_flag` を追加。表にも列追加。

2. 採用基準（初期値）
   - ROI>1.05 かつ races≥200 を満たす層のみ採用
   - 同一レースでは A/B/C 頭数が満たせる最上位1件を推奨（なければ空欄）

3. 推奨への組込み（`scripts/analytics/build-ev.ts`）
   - 三連単関連の出力は削除（または A≥2 でも非表示）
   - 馬連のみ `notes` に簡潔表示（例: `馬連 AA A2/B1 cap∞ ROI1.85 n=277`）
   - 層別キー: `(track_code, ground, bias_flag)` を用いて参照

## 展開バイアス仕様（要点メモ）
- 展開カウント: C:+0.5, B:+1.0, A不在:-2.5, A≥2:+1.5, B≤2:-1.0
- 展開あり: `pace_score<=4.0` かつ `pace_score != -3.5`

## 参考（コマンド）
```
npm run -s bt:pairs -- 20250927 3
sed -n '1,120p' data/analytics/pairs-backtest-latest.md | cat
```


